<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federal Permits | BevAlc Intelligence</title>
    <meta name="description" content="Browse TTB federal permit holders - importers, wineries, and distilleries. Find licensed businesses before they launch products.">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="icon" href="/favicon-192.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .leads-hero {
            background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-bg-tertiary) 100%);
            padding: var(--space-3xl) var(--space-xl);
            text-align: center;
            border-bottom: 1px solid var(--color-border);
            margin-top: 64px;
        }
        .leads-hero h1 {
            font-family: var(--font-display);
            font-size: 2.25rem;
            color: var(--color-text);
            margin-bottom: var(--space-md);
        }
        .leads-hero p {
            color: var(--color-text-secondary);
            max-width: 640px;
            margin: 0 auto;
            font-size: 1.1rem;
            line-height: 1.7;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-lg);
            max-width: 800px;
            margin: var(--space-2xl) auto 0;
        }
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .stat-card {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-primary);
        }
        .stat-card .label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-top: var(--space-xs);
        }

        .leads-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-2xl) var(--space-xl);
        }

        .filters-bar {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }
        .filters-bar label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-secondary);
        }
        .filters-bar select {
            padding: 10px 14px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            background: var(--color-bg);
            color: var(--color-text);
            font-size: 0.9rem;
            font-family: var(--font-body);
            cursor: pointer;
            min-width: 160px;
        }
        .filters-bar select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }
        .export-btn {
            padding: 10px 20px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            margin-left: auto;
            transition: background var(--transition-fast);
        }
        .export-btn:hover {
            background: var(--color-primary-hover);
        }

        .leads-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-bg);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
        }
        .leads-table th, .leads-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        .leads-table th {
            background: var(--color-bg-secondary);
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .leads-table tbody tr {
            transition: background var(--transition-fast);
        }
        .leads-table tbody tr:hover {
            background: var(--color-bg-secondary);
        }
        .leads-table tbody tr:last-child td {
            border-bottom: none;
        }
        .leads-table td {
            font-size: 0.9rem;
        }

        .permit-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .permit-badge.importer { background: #dbeafe; color: #1e40af; }
        .permit-badge.winery { background: #fce7f3; color: #9d174d; }
        .permit-badge.distillery { background: #fef3c7; color: #92400e; }

        .new-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--color-success);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 8px;
            vertical-align: middle;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-sm);
            margin-top: var(--space-xl);
        }
        .pagination button {
            padding: 10px 18px;
            border: 1px solid var(--color-border);
            background: var(--color-bg);
            color: var(--color-text);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all var(--transition-fast);
        }
        .pagination button:hover:not(:disabled) {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .pagination .page-info {
            padding: 10px 16px;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .pro-gate {
            text-align: center;
            padding: var(--space-3xl) var(--space-xl);
            max-width: 500px;
            margin: 0 auto;
        }
        .pro-gate-icon {
            width: 64px;
            height: 64px;
            background: var(--color-primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-lg);
        }
        .pro-gate-icon svg {
            width: 32px;
            height: 32px;
            color: var(--color-primary);
        }
        .pro-gate h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            margin-bottom: var(--space-md);
            color: var(--color-text);
        }
        .pro-gate p {
            color: var(--color-text-secondary);
            margin-bottom: var(--space-xl);
            line-height: 1.7;
        }

        .loading {
            text-align: center;
            padding: var(--space-3xl);
            color: var(--color-text-secondary);
        }
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: var(--space-sm);
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .company-name {
            font-weight: 500;
            color: var(--color-text);
        }
        .permit-number {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        @media (max-width: 768px) {
            .leads-hero h1 {
                font-size: 1.75rem;
            }
            .filters-bar {
                flex-direction: column;
                align-items: stretch;
            }
            .filters-bar select {
                width: 100%;
            }
            .export-btn {
                margin-left: 0;
                width: 100%;
            }
            .leads-table {
                font-size: 0.85rem;
            }
            .leads-table th, .leads-table td {
                padding: 10px 12px;
            }
            /* Hide DBA column on mobile */
            .leads-table th:nth-child(2),
            .leads-table td:nth-child(2) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span class="logo-icon">&#9670;</span>
                <span class="logo-text">BevAlc Intelligence</span>
                <span class="user-status user-status-mobile" id="user-status-mobile"></span>
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <div class="nav-dropdown" id="browse-dropdown">
                    <button class="nav-dropdown-toggle" onclick="toggleDropdown('browse-dropdown')">
                        Browse
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="nav-dropdown-menu">
                        <a href="/whiskey/">Whiskey</a>
                        <a href="/tequila/">Tequila</a>
                        <a href="/vodka/">Vodka</a>
                        <a href="/gin/">Gin</a>
                        <a href="/rum/">Rum</a>
                        <a href="/wine/">Wine</a>
                        <a href="/beer/">Beer</a>
                        <div class="nav-dropdown-divider"></div>
                        <div class="nav-dropdown-more">
                            <a href="#">More <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m9 6 6 6-6 6"/></svg></a>
                            <div class="nav-dropdown-submenu">
                                <a href="/brandy/">Brandy</a>
                                <a href="/liqueur/">Liqueur</a>
                                <a href="/cocktails/">Cocktails</a>
                                <a href="/other/">Other</a>
                            </div>
                        </div>
                    </div>
                </div>
                <a href="database.html" class="nav-link">Database</a>
                <a href="index.html#pricing" class="nav-link">Pricing</a>
                <a href="leads.html" class="nav-link active">Permits</a>
                <a href="account.html" class="nav-link">Account</a>
            </div>
            <div class="nav-user" id="nav-user">
                <span class="user-greeting" id="user-greeting"></span>
                <a href="index.html#signup" class="nav-cta" id="nav-cta">Get Access</a>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
        <div class="mobile-menu" id="mobile-menu">
            <a href="index.html" class="mobile-menu-link">Home</a>
            <a href="database.html" class="mobile-menu-link">Database</a>
            <a href="leads.html" class="mobile-menu-link active">Permits</a>
            <a href="account.html" class="mobile-menu-link">Account</a>
            <div class="mobile-menu-divider"></div>
            <span class="mobile-menu-section">Browse Categories</span>
            <a href="/whiskey/" class="mobile-menu-link">Whiskey</a>
            <a href="/tequila/" class="mobile-menu-link">Tequila</a>
            <a href="/vodka/" class="mobile-menu-link">Vodka</a>
            <a href="/gin/" class="mobile-menu-link">Gin</a>
            <a href="/rum/" class="mobile-menu-link">Rum</a>
            <a href="/wine/" class="mobile-menu-link">Wine</a>
            <a href="/beer/" class="mobile-menu-link">Beer</a>
        </div>
    </nav>

    <div class="leads-hero">
        <h1>Federal Permits</h1>
        <p>Browse TTB permit holders - importers, wineries, and distilleries licensed to operate in the US. Filter to find businesses that haven't filed product labels yet.</p>
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="value" id="stat-importers">-</div>
                <div class="label">Importers</div>
            </div>
            <div class="stat-card">
                <div class="value" id="stat-wineries">-</div>
                <div class="label">Wineries</div>
            </div>
            <div class="stat-card">
                <div class="value" id="stat-distilleries">-</div>
                <div class="label">Distilleries</div>
            </div>
            <div class="stat-card">
                <div class="value" id="stat-new">-</div>
                <div class="label">New This Week</div>
            </div>
        </div>
    </div>

    <div id="content" class="leads-content">
        <div class="loading"><span class="loading-spinner"></span>Loading...</div>
    </div>

    <!-- Permit Detail Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title" id="modal-title">Company Name</h2>
                    <p class="modal-subtitle" id="modal-subtitle">Permit Number</p>
                </div>
                <button class="modal-close" id="modal-close">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <div class="footer-brand-name">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                        BevAlc Intelligence
                    </div>
                    <p class="footer-tagline">Track every satisfying TTB label approval. The industry's most comprehensive COLA database.</p>
                </div>
                <div class="footer-column">
                    <h4>Categories</h4>
                    <ul>
                        <li><a href="/whiskey/">Whiskey</a></li>
                        <li><a href="/tequila/">Tequila</a></li>
                        <li><a href="/vodka/">Vodka</a></li>
                        <li><a href="/gin/">Gin</a></li>
                        <li><a href="/rum/">Rum</a></li>
                        <li><a href="/wine/">Wine</a></li>
                        <li><a href="/beer/">Beer</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="database.html">Search Database</a></li>
                        <li><a href="leads.html">Federal Permits</a></li>
                        <li><a href="glossary.html">Glossary</a></li>
                        <li><a href="index.html#pricing">Pricing</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="legal.html#terms">Terms of Service</a></li>
                        <li><a href="legal.html#privacy">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="footer-copyright">&copy; 2025 BevAlc Intelligence. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="auth.js"></script>
    <script>
        const API_BASE = 'https://bevalc-api.mac-rowan.workers.dev';
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = { permit_type: '', state: '' };
        let userEmail = null;
        let isPro = false;
        let permitsData = []; // Store permit data for modal access

        async function init() {
            // Setup nav
            setupNav();

            // Check auth
            const userInfo = localStorage.getItem('bevalc_user');
            if (userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    userEmail = user.email;
                    isPro = user.isPro || false;

                    // Check Pro status from API
                    if (user.email) {
                        await checkProStatus(user.email);
                    }
                } catch (e) {}
            }

            // Load stats (public)
            await loadStats();

            // Check Pro access
            if (!isPro) {
                showProGate();
                return;
            }

            // Load leads
            showLeadsUI();
            await loadLeads();
        }

        function setupNav() {
            const hasAccess = BevAlcAuth.hasAccess();
            const user = BevAlcAuth.getUser();
            if (hasAccess) {
                const navCta = document.getElementById('nav-cta');
                const userGreeting = document.getElementById('user-greeting');
                if (navCta) navCta.style.display = 'none';
                if (userGreeting && user && user.firstName) {
                    userGreeting.textContent = 'Hi, ' + user.firstName;
                    userGreeting.style.display = 'inline';
                }
            }
        }

        async function checkProStatus(email) {
            try {
                const response = await fetch(`${API_BASE}/api/stripe/customer-status?email=${encodeURIComponent(email)}`);
                const data = await response.json();
                if (data.success && data.status === 'pro') {
                    isPro = true;
                    // Update localStorage
                    const userInfo = localStorage.getItem('bevalc_user');
                    if (userInfo) {
                        const user = JSON.parse(userInfo);
                        user.isPro = true;
                        localStorage.setItem('bevalc_user', JSON.stringify(user));
                    }
                    // Show Pro badge
                    const mobileBadge = document.getElementById('user-status-mobile');
                    if (mobileBadge) {
                        mobileBadge.textContent = 'Pro';
                        mobileBadge.style.display = 'inline-flex';
                    }
                }
            } catch (e) {
                console.log('Could not check Pro status');
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/api/permits/stats`);
                const data = await res.json();
                if (data.success) {
                    const stats = data.stats;
                    const byType = {};
                    for (const t of stats.byType) {
                        byType[t.industry_type] = t.leads;
                    }
                    document.getElementById('stat-importers').textContent = (byType['Importer (Alcohol)'] || 0).toLocaleString();
                    document.getElementById('stat-wineries').textContent = (byType['Wine Producer'] || 0).toLocaleString();
                    document.getElementById('stat-distilleries').textContent = (byType['Distilled Spirits Plant'] || 0).toLocaleString();
                    document.getElementById('stat-new').textContent = (stats.newThisWeek || 0).toLocaleString();
                }
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        }

        function showProGate() {
            document.getElementById('content').innerHTML = `
                <div class="pro-gate">
                    <div class="pro-gate-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </div>
                    <h2>Pro Feature</h2>
                    <p>Access to the federal permits directory requires a Pro subscription. Browse and export 80,000+ licensed importers, wineries, and distilleries. Filter by permit type and state.</p>
                    <a href="index.html#pricing" class="btn btn-primary">Upgrade to Pro</a>
                </div>
            `;
        }

        const US_STATES = [
            ['AL','Alabama'],['AK','Alaska'],['AZ','Arizona'],['AR','Arkansas'],['CA','California'],
            ['CO','Colorado'],['CT','Connecticut'],['DE','Delaware'],['FL','Florida'],['GA','Georgia'],
            ['HI','Hawaii'],['ID','Idaho'],['IL','Illinois'],['IN','Indiana'],['IA','Iowa'],
            ['KS','Kansas'],['KY','Kentucky'],['LA','Louisiana'],['ME','Maine'],['MD','Maryland'],
            ['MA','Massachusetts'],['MI','Michigan'],['MN','Minnesota'],['MS','Mississippi'],['MO','Missouri'],
            ['MT','Montana'],['NE','Nebraska'],['NV','Nevada'],['NH','New Hampshire'],['NJ','New Jersey'],
            ['NM','New Mexico'],['NY','New York'],['NC','North Carolina'],['ND','North Dakota'],['OH','Ohio'],
            ['OK','Oklahoma'],['OR','Oregon'],['PA','Pennsylvania'],['RI','Rhode Island'],['SC','South Carolina'],
            ['SD','South Dakota'],['TN','Tennessee'],['TX','Texas'],['UT','Utah'],['VT','Vermont'],
            ['VA','Virginia'],['WA','Washington'],['WV','West Virginia'],['WI','Wisconsin'],['WY','Wyoming'],
            ['DC','Washington DC'],['PR','Puerto Rico']
        ];

        function showLeadsUI() {
            const stateOptions = US_STATES.map(([code,name]) => `<option value="${code}">${name}</option>`).join('');
            document.getElementById('content').innerHTML = `
                <div class="filters-bar">
                    <label for="filter-type">Permit Type</label>
                    <select id="filter-type" onchange="filterChanged()">
                        <option value="">All Types</option>
                        <option value="Importer">Importers</option>
                        <option value="Winery">Wineries</option>
                        <option value="Distillery">Distilleries</option>
                    </select>
                    <label for="filter-state">State</label>
                    <select id="filter-state" onchange="filterChanged()">
                        <option value="">All States</option>
                        ${stateOptions}
                    </select>
                    <button class="export-btn" onclick="exportLeads()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 6px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7,10 12,15 17,10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Export CSV
                    </button>
                </div>
                <table class="leads-table">
                    <thead>
                        <tr>
                            <th>Company Name</th>
                            <th>DBA / Trade Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Permit #</th>
                        </tr>
                    </thead>
                    <tbody id="leads-body">
                        <tr><td colspan="5" class="loading"><span class="loading-spinner"></span>Loading permits...</td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="pagination"></div>
            `;
        }

        async function loadLeads() {
            const tbody = document.getElementById('leads-body');
            tbody.innerHTML = '<tr><td colspan="5" class="loading"><span class="loading-spinner"></span>Loading...</td></tr>';

            const params = new URLSearchParams({
                page: currentPage,
                limit: 50,
                email: userEmail
            });
            if (currentFilters.permit_type) params.set('permit_type', currentFilters.permit_type);
            if (currentFilters.state) params.set('state', currentFilters.state);

            try {
                const res = await fetch(`${API_BASE}/api/permits/leads?${params}`);
                const data = await res.json();

                if (!data.success) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--color-error);">${data.error}</td></tr>`;
                    return;
                }

                totalPages = data.pagination.totalPages;
                renderLeads(data.data);
                renderPagination(data.pagination);
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--color-error);">Error loading permits. Please try again.</td></tr>';
            }
        }

        function renderLeads(leads) {
            const tbody = document.getElementById('leads-body');
            permitsData = leads; // Store for modal access

            if (leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:48px;">No permits found matching your filters.</td></tr>';
                return;
            }

            tbody.innerHTML = leads.map((lead, index) => {
                const typeClass = lead.industry_type === 'Importer (Alcohol)' ? 'importer' :
                                  lead.industry_type === 'Wine Producer' ? 'winery' : 'distillery';
                const typeLabel = lead.industry_type === 'Importer (Alcohol)' ? 'Importer' :
                                  lead.industry_type === 'Wine Producer' ? 'Winery' : 'Distillery';
                return `
                    <tr onclick="openPermitModal(${index})" style="cursor: pointer;">
                        <td><span class="company-name">${escapeHtml(lead.owner_name)}</span>${lead.is_new ? '<span class="new-badge">NEW</span>' : ''}</td>
                        <td>${escapeHtml(lead.operating_name || '-')}</td>
                        <td><span class="permit-badge ${typeClass}">${typeLabel}</span></td>
                        <td>${escapeHtml(lead.city)}${lead.city && lead.state ? ', ' : ''}${escapeHtml(lead.state)}</td>
                        <td><span class="permit-number">${escapeHtml(lead.permit_number)}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            container.innerHTML = `
                <button onclick="changePage(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px;"><path d="m15 18-6-6 6-6"/></svg>
                    Previous
                </button>
                <span class="page-info">Page ${pagination.page} of ${pagination.totalPages} (${pagination.total.toLocaleString()} permits)</span>
                <button onclick="changePage(${pagination.page + 1})" ${pagination.page >= pagination.totalPages ? 'disabled' : ''}>
                    Next
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px;"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            `;
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadLeads();
            // Scroll to top of table
            document.querySelector('.leads-content').scrollIntoView({ behavior: 'smooth' });
        }

        function filterChanged() {
            currentFilters.permit_type = document.getElementById('filter-type').value;
            currentFilters.state = document.getElementById('filter-state').value;
            currentPage = 1;
            loadLeads();
        }

        function exportLeads() {
            const btn = document.querySelector('.export-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;margin-right:6px;vertical-align:-2px;"></span>Exporting...';
            btn.disabled = true;

            const params = new URLSearchParams({
                email: userEmail,
                limit: 10000
            });
            if (currentFilters.permit_type) params.set('permit_type', currentFilters.permit_type);
            if (currentFilters.state) params.set('state', currentFilters.state);

            fetch(`${API_BASE}/api/permits/leads?${params}`)
                .then(res => res.json())
                .then(data => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;

                    if (!data.success) {
                        alert(data.error);
                        return;
                    }
                    const csv = [
                        ['Company Name', 'DBA', 'Permit Type', 'City', 'State', 'Permit Number'].join(','),
                        ...data.data.map(l => [
                            `"${(l.owner_name || '').replace(/"/g, '""')}"`,
                            `"${(l.operating_name || '').replace(/"/g, '""')}"`,
                            l.industry_type,
                            `"${(l.city || '').replace(/"/g, '""')}"`,
                            l.state,
                            l.permit_number
                        ].join(','))
                    ].join('\n');

                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bevalc-permits-${new Date().toISOString().slice(0,10)}.csv`;
                    a.click();
                })
                .catch(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    alert('Export failed. Please try again.');
                });
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            menu.classList.toggle('open');
            btn.classList.toggle('open');
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            menu.classList.remove('open');
            btn.classList.remove('open');
        }

        document.getElementById('mobile-menu-btn')?.addEventListener('click', toggleMobileMenu);

        document.addEventListener('click', function(e) {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                closeMobileMenu();
            }
        });

        // Dropdown toggle
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const isOpen = dropdown.classList.contains('open');
            document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
            if (!isOpen) dropdown.classList.add('open');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
            }
        });

        // Modal functions
        function openPermitModal(index) {
            const permit = permitsData[index];
            if (!permit) return;

            const modalOverlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const modalBody = document.getElementById('modal-body');

            // Type badge
            const typeClass = permit.industry_type === 'Importer (Alcohol)' ? 'importer' :
                              permit.industry_type === 'Wine Producer' ? 'winery' : 'distillery';
            const typeLabel = permit.industry_type === 'Importer (Alcohol)' ? 'Importer' :
                              permit.industry_type === 'Wine Producer' ? 'Winery' : 'Distillery';

            // Set title with company name and NEW badge if applicable
            modalTitle.innerHTML = `${escapeHtml(permit.owner_name)}${permit.is_new ? '<span class="new-badge" style="margin-left: 12px;">NEW</span>' : ''}`;
            modalSubtitle.textContent = permit.permit_number;

            // Format address
            let addressParts = [];
            if (permit.street) addressParts.push(permit.street);
            let cityStateZip = [];
            if (permit.city) cityStateZip.push(permit.city);
            if (permit.state) cityStateZip.push(permit.state);
            if (permit.zip) cityStateZip.push(permit.zip);
            if (cityStateZip.length > 0) addressParts.push(cityStateZip.join(', '));
            const fullAddress = addressParts.join('<br>');

            // Format dates
            const firstSeen = permit.first_seen_at ? new Date(permit.first_seen_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';
            const lastUpdated = permit.updated_at ? new Date(permit.updated_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';

            // Google search link for company research
            const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(permit.owner_name + ' ' + (permit.operating_name || '') + ' ' + (permit.city || '') + ' ' + (permit.state || ''))}`;

            // Build modal body
            modalBody.innerHTML = `
                <div class="modal-section">
                    <h4>Permit Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Permit Number</span>
                            <span class="detail-value" style="font-family: monospace;">${escapeHtml(permit.permit_number)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Permit Type</span>
                            <span class="detail-value"><span class="permit-badge ${typeClass}">${typeLabel}</span></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">First Seen</span>
                            <span class="detail-value">${firstSeen}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Last Updated</span>
                            <span class="detail-value">${lastUpdated}</span>
                        </div>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Company Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Legal Name</span>
                            <span class="detail-value">${escapeHtml(permit.owner_name)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">DBA / Trade Name</span>
                            <span class="detail-value">${escapeHtml(permit.operating_name || '-')}</span>
                        </div>
                        <div class="detail-item" style="grid-column: span 2;">
                            <span class="detail-label">Address</span>
                            <span class="detail-value">${fullAddress || '-'}</span>
                        </div>
                        ${permit.county ? `
                        <div class="detail-item">
                            <span class="detail-label">County</span>
                            <span class="detail-value">${escapeHtml(permit.county)}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-section" style="border-bottom: none;">
                    <h4>Research</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <a href="${googleSearchUrl}" target="_blank" rel="noopener" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--color-bg-secondary); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text); text-decoration: none; font-size: 0.875rem; font-weight: 500;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                            Search Google
                        </a>
                    </div>
                </div>
            `;

            modalOverlay.classList.add('active');
        }

        function closePermitModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        // Modal event listeners
        document.getElementById('modal-close')?.addEventListener('click', closePermitModal);
        document.getElementById('modal-overlay')?.addEventListener('click', function(e) {
            if (e.target === this) closePermitModal();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closePermitModal();
        });

        init();
    </script>
</body>
</html>
