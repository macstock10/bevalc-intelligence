<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome | BevAlc Intelligence</title>
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="icon" href="/favicon-192.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style-dark.css">
    <style>
        .success-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .success-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-2xl);
            padding: 3rem;
            text-align: center;
            max-width: 480px;
            width: 100%;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: rgba(34, 197, 94, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }
        
        .success-icon svg {
            width: 40px;
            height: 40px;
            color: #4ade80;
        }
        
        .success-card h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: 0.75rem;
        }
        
        .success-card p {
            color: var(--color-text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .success-card .btn {
            margin-top: 0.5rem;
        }
        
        .success-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .success-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn-secondary {
            display: inline-block;
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            text-decoration: none;
            margin-top: 1rem;
            transition: all 0.15s ease;
        }
        
        .btn-secondary:hover {
            border-color: var(--color-text-secondary);
            color: var(--color-text-primary);
        }
        
        .preferences-loading {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-top: 1rem;
        }
        
        .preferences-loading .mini-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animation">
        <div class="particles" id="particles"></div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span class="logo-icon">â—†</span>
                <span class="logo-text">BevAlc Intelligence</span>
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="database.html" class="nav-link">Database</a>
                <div class="nav-dropdown" id="browse-dropdown">
                    <button class="nav-dropdown-toggle" onclick="toggleDropdown('browse-dropdown')">
                        Browse
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="nav-dropdown-menu">
                        <a href="/whiskey/">Whiskey</a>
                        <a href="/tequila/">Tequila</a>
                        <a href="/vodka/">Vodka</a>
                        <a href="/gin/">Gin</a>
                        <a href="/rum/">Rum</a>
                        <a href="/wine/">Wine</a>
                        <a href="/beer/">Beer</a>
                        <div class="nav-dropdown-more">
                            <a href="#">More <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m9 18 6-6-6-6"/></svg></a>
                            <div class="nav-dropdown-submenu">
                                <a href="/brandy/">Brandy</a>
                                <a href="/liqueur/">Liqueur</a>
                                <a href="/cocktails/">Cocktails</a>
                                <a href="/other/">Other</a>
                            </div>
                        </div>
                    </div>
                </div>
                <a href="index.html#pricing" class="nav-link">Pricing</a>
                <a href="leads.html" class="nav-link">Permits</a>
                <a href="account.html" class="nav-link">Account</a>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
        <div class="mobile-menu" id="mobile-menu">
            <a href="index.html" class="mobile-menu-link">Home</a>
            <a href="database.html" class="mobile-menu-link">Database</a>
            <a href="index.html#pricing" class="mobile-menu-link">Pricing</a>
            <a href="account.html" class="mobile-menu-link">Account</a>
            <div class="mobile-menu-divider"></div>
            <span class="mobile-menu-section">Browse Categories</span>
            <a href="/whiskey/" class="mobile-menu-link">Whiskey</a>
            <a href="/tequila/" class="mobile-menu-link">Tequila</a>
            <a href="/vodka/" class="mobile-menu-link">Vodka</a>
            <a href="/gin/" class="mobile-menu-link">Gin</a>
            <a href="/rum/" class="mobile-menu-link">Rum</a>
            <a href="/wine/" class="mobile-menu-link">Wine</a>
            <a href="/beer/" class="mobile-menu-link">Beer</a>
            <a href="/brandy/" class="mobile-menu-link">Brandy</a>
            <a href="/liqueur/" class="mobile-menu-link">Liqueur</a>
            <a href="/cocktails/" class="mobile-menu-link">Cocktails</a>
            <a href="/other/" class="mobile-menu-link">Other</a>
        </div>
    </nav>

    <!-- Success Content -->
    <main class="success-page">
        <div class="success-card" id="success-card">
            <div class="success-loading" id="loading-state">
                <div class="spinner"></div>
                <p>Activating your subscription...</p>
            </div>

            <div id="success-state" style="display: none;">
                <div class="success-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <h1 id="success-title">Welcome!</h1>
                <p id="success-description">Your subscription is now active. You have full access to category packs, CSV exports, and weekly intel reports.</p>
                
                <div id="preferences-section">
                    <a href="#" id="preferences-link" class="btn btn-glow" style="display: none;">Choose Your Categories</a>
                    <p id="preferences-loading" class="preferences-loading">
                        <span class="mini-spinner"></span>Loading preferences...
                    </p>
                    <p id="preferences-note" style="display: none; margin-top: 1rem; font-size: 0.875rem; color: var(--color-text-secondary);">
                        Select which category reports you want to receive each week.
                    </p>
                </div>
                
                <a href="database.html" class="btn btn-secondary">Go to Database</a>
            </div>
            
            <div id="error-state" style="display: none;">
                <h1>Something went wrong</h1>
                <p>We couldn't confirm your subscription. Please contact support if you were charged.</p>
                <a href="mailto:hello@bevalcintel.com" class="btn btn-glow">Contact Support</a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <div class="footer-brand-name">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                        BevAlc Intelligence
                    </div>
                    <p class="footer-tagline">Track every satisfying TTB label approval. The industry's most comprehensive COLA database.</p>
                </div>
                <div class="footer-column">
                    <h4>Categories</h4>
                    <ul>
                        <li><a href="/whiskey/">Whiskey</a></li>
                        <li><a href="/tequila/">Tequila</a></li>
                        <li><a href="/vodka/">Vodka</a></li>
                        <li><a href="/gin/">Gin</a></li>
                        <li><a href="/rum/">Rum</a></li>
                        <li><a href="/wine/">Wine</a></li>
                        <li><a href="/beer/">Beer</a></li>
                        <li><a href="/brandy/">Brandy</a></li>
                        <li><a href="/liqueur/">Liqueur</a></li>
                        <li><a href="/cocktails/">Cocktails</a></li>
                        <li><a href="/other/">Other</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="database.html">Search Database</a></li>
                        <li><a href="glossary.html">Glossary</a></li>
                        <li><a href="index.html#pricing">Pricing</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="legal.html#terms">Terms of Service</a></li>
                        <li><a href="legal.html#privacy">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="footer-copyright">&copy; 2025 BevAlc Intelligence. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="auth.js"></script>
    <script>
        const API_BASE = 'https://bevalc-api.mac-rowan.workers.dev';
        
        // Create particles
        function createParticles() {
            const container = document.getElementById('particles');
            if (!container) return;
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 20) + 's';
                container.appendChild(particle);
            }
        }
        
        if (window.matchMedia('(prefers-reduced-motion: no-preference)').matches) {
            createParticles();
        }
        
        // Handle success page logic
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            
            const loadingState = document.getElementById('loading-state');
            const successState = document.getElementById('success-state');
            const errorState = document.getElementById('error-state');
            
            if (!sessionId) {
                // No session ID - check if user is logged in and Pro
                const user = BevAlcAuth.getUser();
                if (user && user.isPro) {
                    loadingState.style.display = 'none';
                    successState.style.display = 'block';
                    fetchPreferencesToken(user.email);
                } else {
                    loadingState.style.display = 'none';
                    errorState.style.display = 'block';
                }
                return;
            }
            
            try {
                // Verify the checkout session with Stripe
                const response = await fetch(`${API_BASE}/api/stripe/verify-session?session_id=${sessionId}`);
                const data = await response.json();
                
                loadingState.style.display = 'none';
                
                if (data.success && data.status === 'complete') {
                    const customerEmail = data.customer_email;

                    // Save user info locally
                    localStorage.setItem('bevalc_user', JSON.stringify({
                        email: customerEmail,
                        isPro: true,
                        tier: 'pro',
                        signedUpAt: new Date().toISOString()
                    }));
                    BevAlcAuth.grantAccess();

                    // Update title and description
                    document.getElementById('success-title').textContent = 'Welcome to Pro!';
                    document.getElementById('success-description').textContent = 'Your subscription is now active. You have full access to all categories, CSV exports, and weekly intel reports.';

                    // Show success immediately
                    successState.style.display = 'block';
                    
                    // If we got a token from verify-session, use it immediately
                    if (data.preferences_token) {
                        showPreferencesLink(data.preferences_token);
                    } else {
                        // Fetch it in the background
                        fetchPreferencesToken(customerEmail);
                    }
                } else {
                    errorState.style.display = 'block';
                }
            } catch (e) {
                console.error('Error verifying session:', e);
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
            }
        });
        
        function showPreferencesLink(token) {
            const link = document.getElementById('preferences-link');
            const loading = document.getElementById('preferences-loading');
            const note = document.getElementById('preferences-note');
            
            link.href = `preferences.html?token=${token}`;
            link.style.display = 'inline-block';
            loading.style.display = 'none';
            note.style.display = 'block';
        }
        
        function showPreferencesError() {
            const loading = document.getElementById('preferences-loading');
            loading.innerHTML = 'ðŸ“§ Check your email for a link to choose your categories.';
        }
        
        // Fetch preferences token in background
        async function fetchPreferencesToken(email) {
            if (!email) {
                showPreferencesError();
                return;
            }
            
            // Retry a few times since webhook might be delayed
            let attempts = 0;
            const maxAttempts = 3;
            const delay = 2000; // 2 seconds between attempts
            
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`${API_BASE}/api/user/preferences?email=${encodeURIComponent(email)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // Need to get token - fetch it via send-preferences-link endpoint
                        const tokenResponse = await fetch(`${API_BASE}/api/user/send-preferences-link`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: email })
                        });
                        const tokenData = await tokenResponse.json();
                        
                        if (tokenData.success && tokenData._debug_url) {
                            // Extract token from URL
                            const url = new URL(tokenData._debug_url);
                            const token = url.searchParams.get('token');
                            if (token) {
                                showPreferencesLink(token);
                                return;
                            }
                        }
                    }
                } catch (e) {
                    console.log(`Attempt ${attempts + 1} failed:`, e);
                }
                
                attempts++;
                if (attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            // All attempts failed
            showPreferencesError();
        }

        // Dropdown toggle
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const isOpen = dropdown.classList.contains('open');
            document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
            if (!isOpen) dropdown.classList.add('open');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
            }
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            menu.classList.toggle('open');
            btn.classList.toggle('open');
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            menu.classList.remove('open');
            btn.classList.remove('open');
        }

        document.getElementById('mobile-menu-btn')?.addEventListener('click', toggleMobileMenu);

        document.addEventListener('click', function(e) {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                closeMobileMenu();
            }
        });
    </script>
</body>
</html>
