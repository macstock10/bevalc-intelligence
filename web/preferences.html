<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Preferences | BevAlc Intelligence</title>
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="icon" href="/favicon-192.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style-dark.css">
    <style>
        .preferences-page { min-height: 100vh; padding: 6rem 2rem 4rem; }
        .preferences-container { max-width: 640px; margin: 0 auto; }
        .preferences-header { text-align: center; margin-bottom: 2rem; }
        .preferences-header h1 { font-size: 2rem; font-weight: 700; color: var(--color-text-primary); margin-bottom: 0.5rem; }
        .preferences-header p { color: var(--color-text-secondary); }
        .preferences-card { background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--radius-2xl); padding: 2rem; }
        .preferences-section { margin-bottom: 2rem; }
        .preferences-section:last-child { margin-bottom: 0; }
        .preferences-section h2 { font-size: 1.125rem; font-weight: 600; color: var(--color-text-primary); margin-bottom: 0.5rem; }
        .preferences-section p { font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 1rem; }
        .category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        @media (max-width: 480px) { .category-grid { grid-template-columns: 1fr; } }
        .category-option { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.15s ease; }
        .category-option:hover { border-color: var(--color-accent); background: rgba(13, 148, 136, 0.05); }
        .category-option.selected { border-color: var(--color-accent); background: rgba(13, 148, 136, 0.1); }
        .category-option input[type="checkbox"] { width: 1.125rem; height: 1.125rem; accent-color: var(--color-accent); cursor: pointer; }
        .category-option label { flex: 1; cursor: pointer; font-weight: 500; color: var(--color-text-primary); }
        .category-option .category-icon { font-size: 1.25rem; }
        .toggle-option { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-lg); }
        .toggle-label { font-weight: 500; color: var(--color-text-primary); }
        .toggle-desc { font-size: 0.875rem; color: var(--color-text-secondary); margin-top: 0.25rem; }
        .toggle-switch { position: relative; width: 48px; height: 26px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--color-border); transition: 0.2s; border-radius: 26px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: 0.2s; border-radius: 50%; }
        .toggle-switch input:checked + .toggle-slider { background-color: var(--color-accent); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(22px); }
        .preferences-actions { display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border); }
        .preferences-actions .btn { flex: 1; }
        .btn-secondary-dark { background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); }
        .btn-secondary-dark:hover { background: var(--color-bg-card); border-color: var(--color-text-secondary); }
        .loading-state, .error-state, .success-state, .not-pro-state { text-align: center; padding: 3rem 2rem; }
        .loading-state .spinner { width: 40px; height: 40px; border: 3px solid var(--color-border); border-top-color: var(--color-accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-state .error-icon, .success-state .success-icon { width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; }
        .error-state .error-icon { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .success-state .success-icon { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .error-state h2, .success-state h2 { font-size: 1.25rem; margin-bottom: 0.5rem; }
        .error-state p, .success-state p { color: var(--color-text-secondary); }
        .not-pro-state .lock-icon { width: 64px; height: 64px; background: rgba(251, 191, 36, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #fbbf24; }
        .select-helpers { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .select-helper-btn { font-size: 0.75rem; padding: 0.375rem 0.75rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-secondary); cursor: pointer; }
        .select-helper-btn:hover { border-color: var(--color-accent); color: var(--color-accent); }
        .user-email { font-size: 0.875rem; color: var(--color-text-secondary); margin-top: 0.5rem; }
        .user-email strong { color: var(--color-text-primary); }
    </style>
</head>
<body>
    <div class="bg-animation"><div class="particles" id="particles"></div></div>

    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span class="logo-icon">â—†</span>
                <span class="logo-text">BevAlc Intelligence</span>
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="database.html" class="nav-link">Database</a>
                <div class="nav-dropdown" id="browse-dropdown">
                    <button class="nav-dropdown-toggle" onclick="toggleDropdown('browse-dropdown')">
                        Browse
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="nav-dropdown-menu">
                        <a href="/whiskey/">Whiskey</a>
                        <a href="/tequila/">Tequila</a>
                        <a href="/vodka/">Vodka</a>
                        <a href="/gin/">Gin</a>
                        <a href="/rum/">Rum</a>
                        <a href="/wine/">Wine</a>
                        <a href="/beer/">Beer</a>
                        <div class="nav-dropdown-more">
                            <a href="#">More <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m9 18 6-6-6-6"/></svg></a>
                            <div class="nav-dropdown-submenu">
                                <a href="/brandy/">Brandy</a>
                                <a href="/liqueur/">Liqueur</a>
                                <a href="/cocktails/">Cocktails</a>
                                <a href="/other/">Other</a>
                            </div>
                        </div>
                    </div>
                </div>
                <a href="index.html#pricing" class="nav-link">Pricing</a>
                <a href="leads.html" class="nav-link">Permits</a>
                <a href="account.html" class="nav-link">Account</a>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
        <div class="mobile-menu" id="mobile-menu">
            <a href="index.html" class="mobile-menu-link">Home</a>
            <a href="database.html" class="mobile-menu-link">Database</a>
            <a href="index.html#pricing" class="mobile-menu-link">Pricing</a>
            <a href="account.html" class="mobile-menu-link">Account</a>
            <div class="mobile-menu-divider"></div>
            <span class="mobile-menu-section">Browse Categories</span>
            <a href="/whiskey/" class="mobile-menu-link">Whiskey</a>
            <a href="/tequila/" class="mobile-menu-link">Tequila</a>
            <a href="/vodka/" class="mobile-menu-link">Vodka</a>
            <a href="/gin/" class="mobile-menu-link">Gin</a>
            <a href="/rum/" class="mobile-menu-link">Rum</a>
            <a href="/wine/" class="mobile-menu-link">Wine</a>
            <a href="/beer/" class="mobile-menu-link">Beer</a>
            <a href="/brandy/" class="mobile-menu-link">Brandy</a>
            <a href="/liqueur/" class="mobile-menu-link">Liqueur</a>
            <a href="/cocktails/" class="mobile-menu-link">Cocktails</a>
            <a href="/other/" class="mobile-menu-link">Other</a>
        </div>
    </nav>

    <main class="preferences-page">
        <div class="preferences-container">
            <div class="preferences-header">
                <h1>Report Preferences</h1>
                <p>Choose which category reports you want to receive each week.</p>
            </div>
            
            <div class="preferences-card">
                <div class="loading-state" id="loading-state"><div class="spinner"></div><p>Loading your preferences...</p></div>
                
                <div class="error-state" id="error-state" style="display: none;">
                    <div class="error-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></div>
                    <h2>Invalid or Expired Link</h2>
                    <p id="error-message">This preferences link is not valid.</p>
                </div>
                
                <div class="not-pro-state" id="not-pro-state" style="display: none;">
                    <div class="lock-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></div>
                    <h2>Pro Subscription Required</h2>
                    <p>Category reports are a Pro feature.</p>
                    <a href="index.html#pricing" class="btn btn-glow" style="margin-top: 1.5rem;">View Pro Plans</a>
                </div>
                
                <div class="success-state" id="success-state" style="display: none;">
                    <div class="success-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div>
                    <h2>Preferences Saved!</h2>
                    <p>You'll receive reports for your selected categories starting this Sunday.</p>
                    <a href="database.html" class="btn btn-glow" style="margin-top: 1.5rem;">Go to Database</a>
                </div>
                
                <form id="preferences-form" style="display: none;">
                    <div class="preferences-section">
                        <h2>Category Reports</h2>
                        <p>Select the categories you want weekly reports for.</p>
                        <div class="select-helpers">
                            <button type="button" class="select-helper-btn" id="select-all">Select All</button>
                            <button type="button" class="select-helper-btn" id="select-none">Clear All</button>
                        </div>
                        <div class="category-grid" id="category-grid"></div>
                    </div>
                    
                    <div class="preferences-section">
                        <h2>Free Weekly Snapshot</h2>
                        <div class="toggle-option">
                            <div><div class="toggle-label">Receive Weekly Snapshot</div><div class="toggle-desc">Market-wide summary with top-level metrics</div></div>
                            <label class="toggle-switch"><input type="checkbox" id="receive-free-report" checked><span class="toggle-slider"></span></label>
                        </div>
                    </div>
                    
                    <p class="user-email">Signed in as: <strong id="user-email-display"></strong></p>
                    
                    <div class="preferences-actions">
                        <a href="database.html" class="btn btn-secondary-dark">Cancel</a>
                        <button type="submit" class="btn btn-glow" id="save-btn">Save Preferences</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <div class="footer-brand-name">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                        BevAlc Intelligence
                    </div>
                    <p class="footer-tagline">Track every satisfying TTB label approval. The industry's most comprehensive COLA database.</p>
                </div>
                <div class="footer-column">
                    <h4>Categories</h4>
                    <ul>
                        <li><a href="/whiskey/">Whiskey</a></li>
                        <li><a href="/tequila/">Tequila</a></li>
                        <li><a href="/vodka/">Vodka</a></li>
                        <li><a href="/gin/">Gin</a></li>
                        <li><a href="/rum/">Rum</a></li>
                        <li><a href="/wine/">Wine</a></li>
                        <li><a href="/beer/">Beer</a></li>
                        <li><a href="/brandy/">Brandy</a></li>
                        <li><a href="/liqueur/">Liqueur</a></li>
                        <li><a href="/cocktails/">Cocktails</a></li>
                        <li><a href="/other/">Other</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="database.html">Search Database</a></li>
                        <li><a href="glossary.html">Glossary</a></li>
                        <li><a href="index.html#pricing">Pricing</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="legal.html#terms">Terms of Service</a></li>
                        <li><a href="legal.html#privacy">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="footer-copyright">&copy; 2025 BevAlc Intelligence. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE = 'https://bevalc-api.mac-rowan.workers.dev';
        const CATEGORY_ICONS = { 'Whiskey': 'ðŸ¥ƒ', 'Vodka': 'ðŸ¸', 'Tequila': 'ðŸŒµ', 'Rum': 'ðŸï¸', 'Gin': 'ðŸ«’', 'Brandy': 'ðŸ‡', 'Wine': 'ðŸ·', 'Beer': 'ðŸº', 'Liqueur': 'ðŸ¬', 'RTD': 'ðŸ¥¤' };
        let currentToken = null;

        function showState(state) {
            ['loading-state', 'error-state', 'not-pro-state', 'success-state', 'preferences-form'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById(state === 'form' ? 'preferences-form' : state + '-state').style.display = 'block';
        }

        function buildCategoryGrid(availableCategories, selectedCats) {
            const grid = document.getElementById('category-grid');
            grid.innerHTML = '';
            availableCategories.forEach(cat => {
                const isSelected = selectedCats.includes(cat);
                const option = document.createElement('div');
                option.className = 'category-option' + (isSelected ? ' selected' : '');
                option.innerHTML = `<input type="checkbox" id="cat-${cat}" value="${cat}" ${isSelected ? 'checked' : ''}><label for="cat-${cat}">${cat}</label><span class="category-icon">${CATEGORY_ICONS[cat] || 'ðŸ“¦'}</span>`;
                option.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); const cb = option.querySelector('input'); cb.checked = !cb.checked; option.classList.toggle('selected', cb.checked); });
                option.querySelector('input').addEventListener('click', (e) => { e.stopPropagation(); option.classList.toggle('selected', e.target.checked); });
                grid.appendChild(option);
            });
        }

        async function loadPreferences() {
            const urlParams = new URLSearchParams(window.location.search);
            currentToken = urlParams.get('token');
            if (!currentToken) { showState('error'); document.getElementById('error-message').textContent = 'No preferences token provided.'; return; }
            
            try {
                const response = await fetch(`${API_BASE}/api/user/preferences?token=${currentToken}`);
                const data = await response.json();
                if (!data.success) { showState('error'); document.getElementById('error-message').textContent = data.error || 'Could not load preferences.'; return; }
                if (!data.is_pro) { showState('not-pro'); return; }
                buildCategoryGrid(data.available_categories, data.categories || []);
                document.getElementById('receive-free-report').checked = data.receive_free_report !== false;
                document.getElementById('user-email-display').textContent = data.email;
                showState('form');
            } catch (e) { showState('error'); document.getElementById('error-message').textContent = 'Could not connect to server.'; }
        }

        async function savePreferences(e) {
            e.preventDefault();
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true; saveBtn.textContent = 'Saving...';
            const categories = Array.from(document.querySelectorAll('#category-grid input:checked')).map(cb => cb.value);
            const receiveFreeReport = document.getElementById('receive-free-report').checked;
            try {
                const response = await fetch(`${API_BASE}/api/user/preferences`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token: currentToken, categories, receive_free_report: receiveFreeReport }) });
                const data = await response.json();
                if (data.success) { showState('success'); } else { alert(data.error || 'Could not save.'); saveBtn.disabled = false; saveBtn.textContent = 'Save Preferences'; }
            } catch (e) { alert('Could not connect.'); saveBtn.disabled = false; saveBtn.textContent = 'Save Preferences'; }
        }

        document.getElementById('select-all')?.addEventListener('click', () => { document.querySelectorAll('#category-grid input').forEach(cb => { cb.checked = true; cb.closest('.category-option').classList.add('selected'); }); });
        document.getElementById('select-none')?.addEventListener('click', () => { document.querySelectorAll('#category-grid input').forEach(cb => { cb.checked = false; cb.closest('.category-option').classList.remove('selected'); }); });
        document.getElementById('preferences-form')?.addEventListener('submit', savePreferences);
        document.addEventListener('DOMContentLoaded', loadPreferences);

        // Dropdown toggle
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const isOpen = dropdown.classList.contains('open');
            document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
            if (!isOpen) dropdown.classList.add('open');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
            }
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            menu.classList.toggle('open');
            btn.classList.toggle('open');
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            menu.classList.remove('open');
            btn.classList.remove('open');
        }

        document.getElementById('mobile-menu-btn')?.addEventListener('click', toggleMobileMenu);

        document.addEventListener('click', function(e) {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                closeMobileMenu();
            }
        });
    </script>
</body>
</html>
