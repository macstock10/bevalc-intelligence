<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Preferences | BevAlc Intelligence</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚óÜ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style-dark.css">
    <style>
        .preferences-page {
            min-height: 100vh;
            padding: 6rem 2rem 4rem;
        }
        
        .preferences-container {
            max-width: 640px;
            margin: 0 auto;
        }
        
        .preferences-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .preferences-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
        }
        
        .preferences-header p {
            color: var(--color-text-secondary);
        }
        
        .preferences-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-2xl);
            padding: 2rem;
        }
        
        .preferences-section {
            margin-bottom: 2rem;
        }
        
        .preferences-section:last-child {
            margin-bottom: 0;
        }
        
        .preferences-section h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
        }
        
        .preferences-section p {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-bottom: 1rem;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        @media (max-width: 480px) {
            .category-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .category-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .category-option:hover {
            border-color: var(--color-accent);
            background: rgba(13, 148, 136, 0.05);
        }
        
        .category-option.selected {
            border-color: var(--color-accent);
            background: rgba(13, 148, 136, 0.1);
        }
        
        .category-option input[type="checkbox"] {
            width: 1.125rem;
            height: 1.125rem;
            accent-color: var(--color-accent);
            cursor: pointer;
        }
        
        .category-option label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-text-primary);
        }
        
        .category-option .category-icon {
            font-size: 1.25rem;
        }
        
        .toggle-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
        }
        
        .toggle-option .toggle-label {
            font-weight: 500;
            color: var(--color-text-primary);
        }
        
        .toggle-option .toggle-desc {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            flex-shrink: 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-border);
            transition: 0.2s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.2s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--color-accent);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        .preferences-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
        }
        
        .preferences-actions .btn {
            flex: 1;
        }
        
        .btn-secondary-dark {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }
        
        .btn-secondary-dark:hover {
            background: var(--color-bg-card);
            border-color: var(--color-text-secondary);
        }
        
        .loading-state,
        .error-state,
        .success-state,
        .not-pro-state {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .loading-state .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-state .error-icon,
        .success-state .success-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }
        
        .error-state .error-icon {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .success-state .success-icon {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .error-state h2,
        .success-state h2 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        .error-state p,
        .success-state p {
            color: var(--color-text-secondary);
        }
        
        .not-pro-state .lock-icon {
            width: 64px;
            height: 64px;
            background: rgba(251, 191, 36, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: #fbbf24;
        }
        
        .request-link-form {
            max-width: 400px;
            margin: 2rem auto 0;
        }
        
        .request-link-form input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            margin-bottom: 0.75rem;
        }
        
        .request-link-form input:focus {
            outline: none;
            border-color: var(--color-accent);
        }
        
        .select-helpers {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .select-helper-btn {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .select-helper-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }
        
        .user-email {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-top: 0.5rem;
        }
        
        .user-email strong {
            color: var(--color-text-primary);
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animation">
        <div class="particles" id="particles"></div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span class="logo-icon">‚óÜ</span>
                <span class="logo-text">BevAlc Intelligence</span>
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="database.html" class="nav-link">Database</a>
                <a href="index.html#pricing" class="nav-link">Pricing</a>
                <a href="glossary.html" class="nav-link">Glossary</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="preferences-page">
        <div class="preferences-container">
            <div class="preferences-header">
                <h1>Report Preferences</h1>
                <p>Choose which category reports you want to receive each week.</p>
            </div>
            
            <div class="preferences-card">
                <!-- Loading State -->
                <div class="loading-state" id="loading-state">
                    <div class="spinner"></div>
                    <p>Loading your preferences...</p>
                </div>
                
                <!-- Error State -->
                <div class="error-state" id="error-state" style="display: none;">
                    <div class="error-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                    </div>
                    <h2>Invalid or Expired Link</h2>
                    <p id="error-message">This preferences link is not valid. Please use the link from your welcome email.</p>
                    
                    <div class="request-link-form" id="request-link-form">
                        <p style="margin-bottom: 1rem; color: var(--color-text-secondary);">Enter your email to receive a new link:</p>
                        <input type="email" id="request-email" placeholder="you@company.com">
                        <button class="btn btn-glow" id="request-link-btn" style="width: 100%;">Send Preferences Link</button>
                    </div>
                </div>
                
                <!-- Not Pro State -->
                <div class="not-pro-state" id="not-pro-state" style="display: none;">
                    <div class="lock-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </div>
                    <h2>Pro Subscription Required</h2>
                    <p>Category reports are a Pro feature. Upgrade to select which reports you receive.</p>
                    <a href="index.html#pricing" class="btn btn-glow" style="margin-top: 1.5rem;">View Pro Plans</a>
                </div>
                
                <!-- Success State -->
                <div class="success-state" id="success-state" style="display: none;">
                    <div class="success-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <h2>Preferences Saved!</h2>
                    <p>Your category selections have been updated. You'll receive reports for your selected categories starting this Sunday.</p>
                    <a href="database.html" class="btn btn-glow" style="margin-top: 1.5rem;">Go to Database</a>
                </div>
                
                <!-- Preferences Form -->
                <form id="preferences-form" style="display: none;">
                    <div class="preferences-section">
                        <h2>Category Reports</h2>
                        <p>Select the categories you want weekly reports for. You'll receive a detailed PDF for each selected category every Sunday.</p>
                        
                        <div class="select-helpers">
                            <button type="button" class="select-helper-btn" id="select-all">Select All</button>
                            <button type="button" class="select-helper-btn" id="select-none">Clear All</button>
                        </div>
                        
                        <div class="category-grid" id="category-grid">
                            <!-- Categories populated by JS -->
                        </div>
                    </div>
                    
                    <div class="preferences-section">
                        <h2>Free Weekly Snapshot</h2>
                        <p>The free market overview report sent to all subscribers.</p>
                        
                        <div class="toggle-option">
                            <div>
                                <div class="toggle-label">Receive Weekly Snapshot</div>
                                <div class="toggle-desc">Market-wide summary with top-level metrics</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="receive-free-report" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <p class="user-email">Signed in as: <strong id="user-email-display"></strong></p>
                    
                    <div class="preferences-actions">
                        <a href="database.html" class="btn btn-secondary-dark">Cancel</a>
                        <button type="submit" class="btn btn-glow" id="save-btn">
                            <span class="btn-text">Save Preferences</span>
                            <span class="btn-loading" style="display: none;">
                                <svg class="spinner" viewBox="0 0 24 24" width="20" height="20">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="32" stroke-linecap="round"></circle>
                                </svg>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = 'https://bevalc-api.mac-rowan.workers.dev';
        
        const CATEGORY_ICONS = {
            'Whiskey': 'ü•É',
            'Vodka': 'üç∏',
            'Tequila': 'üåµ',
            'Rum': 'üèùÔ∏è',
            'Gin': 'ü´í',
            'Brandy': 'üçá',
            'Wine': 'üç∑',
            'Beer': 'üç∫',
            'Liqueur': 'üç¨',
            'RTD': 'ü•§'
        };
        
        let currentToken = null;
        let selectedCategories = [];
        
        // Create particles
        function createParticles() {
            const container = document.getElementById('particles');
            if (!container) return;
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 20) + 's';
                container.appendChild(particle);
            }
        }
        
        if (window.matchMedia('(prefers-reduced-motion: no-preference)').matches) {
            createParticles();
        }
        
        // Show/hide states
        function showState(state) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'none';
            document.getElementById('not-pro-state').style.display = 'none';
            document.getElementById('success-state').style.display = 'none';
            document.getElementById('preferences-form').style.display = 'none';
            
            if (state === 'loading') {
                document.getElementById('loading-state').style.display = 'block';
            } else if (state === 'error') {
                document.getElementById('error-state').style.display = 'block';
            } else if (state === 'not-pro') {
                document.getElementById('not-pro-state').style.display = 'block';
            } else if (state === 'success') {
                document.getElementById('success-state').style.display = 'block';
            } else if (state === 'form') {
                document.getElementById('preferences-form').style.display = 'block';
            }
        }
        
        // Build category grid
        function buildCategoryGrid(availableCategories, selectedCats) {
            const grid = document.getElementById('category-grid');
            grid.innerHTML = '';
            
            availableCategories.forEach(cat => {
                const isSelected = selectedCats.includes(cat);
                const option = document.createElement('div');
                option.className = 'category-option' + (isSelected ? ' selected' : '');
                option.innerHTML = `
                    <input type="checkbox" id="cat-${cat}" value="${cat}" ${isSelected ? 'checked' : ''}>
                    <label for="cat-${cat}">${cat}</label>
                    <span class="category-icon">${CATEGORY_ICONS[cat] || 'üì¶'}</span>
                `;
                
                // Handle clicks anywhere in the box
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const checkbox = option.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    option.classList.toggle('selected', checkbox.checked);
                });
                
                // Prevent checkbox from double-toggling
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    option.classList.toggle('selected', checkbox.checked);
                });
                
                grid.appendChild(option);
            });
        }
        
        // Load preferences
        async function loadPreferences() {
            const urlParams = new URLSearchParams(window.location.search);
            currentToken = urlParams.get('token');
            
            if (!currentToken) {
                showState('error');
                document.getElementById('error-message').textContent = 'No preferences token provided. Please use the link from your email.';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/user/preferences?token=${currentToken}`);
                const data = await response.json();
                
                if (!data.success) {
                    showState('error');
                    document.getElementById('error-message').textContent = data.error || 'Could not load preferences.';
                    return;
                }
                
                if (!data.is_pro) {
                    showState('not-pro');
                    return;
                }
                
                // Show form with data
                selectedCategories = data.categories || [];
                buildCategoryGrid(data.available_categories, selectedCategories);
                document.getElementById('receive-free-report').checked = data.receive_free_report !== false;
                document.getElementById('user-email-display').textContent = data.email;
                showState('form');
                
            } catch (e) {
                console.error('Error loading preferences:', e);
                showState('error');
                document.getElementById('error-message').textContent = 'Could not connect to server. Please try again.';
            }
        }
        
        // Save preferences
        async function savePreferences(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('save-btn');
            const btnText = saveBtn.querySelector('.btn-text');
            const btnLoading = saveBtn.querySelector('.btn-loading');
            
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-flex';
            saveBtn.disabled = true;
            
            // Collect selected categories
            const checkboxes = document.querySelectorAll('#category-grid input[type="checkbox"]:checked');
            const categories = Array.from(checkboxes).map(cb => cb.value);
            const receiveFreeReport = document.getElementById('receive-free-report').checked;
            
            try {
                const response = await fetch(`${API_BASE}/api/user/preferences`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: currentToken,
                        categories: categories,
                        receive_free_report: receiveFreeReport
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showState('success');
                } else {
                    alert(data.error || 'Could not save preferences. Please try again.');
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                    saveBtn.disabled = false;
                }
            } catch (e) {
                console.error('Error saving preferences:', e);
                alert('Could not connect to server. Please try again.');
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                saveBtn.disabled = false;
            }
        }
        
        // Request new link
        async function requestNewLink() {
            const email = document.getElementById('request-email').value.trim();
            const btn = document.getElementById('request-link-btn');
            
            if (!email) {
                alert('Please enter your email address.');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            try {
                const response = await fetch(`${API_BASE}/api/user/send-preferences-link`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Check your email for your preferences link.');
                } else {
                    alert(data.error || 'Could not send link. Please try again.');
                }
            } catch (e) {
                alert('Could not connect to server. Please try again.');
            }
            
            btn.disabled = false;
            btn.textContent = 'Send Preferences Link';
        }
        
        // Select all / none
        document.getElementById('select-all')?.addEventListener('click', () => {
            document.querySelectorAll('#category-grid input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                cb.closest('.category-option').classList.add('selected');
            });
        });
        
        document.getElementById('select-none')?.addEventListener('click', () => {
            document.querySelectorAll('#category-grid input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.closest('.category-option').classList.remove('selected');
            });
        });
        
        // Event listeners
        document.getElementById('preferences-form')?.addEventListener('submit', savePreferences);
        document.getElementById('request-link-btn')?.addEventListener('click', requestNewLink);
        
        // Init
        document.addEventListener('DOMContentLoaded', loadPreferences);
    </script>
</body>
</html>